<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no, interactive-widget=resizes-content">
    <title>LongGBot Assistant</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}?v={{ range(1, 1000) | random }}" rel="stylesheet">
    <link rel="icon" type="image/jpg" href="{{ url_for('static', filename='img/longgbot_log.jpg') }}">
</head>
<body>
    <!-- Top bar for mobile -->
    <div class="topbar-mobile" id="topbarMobile">
        <button class="burger-btn" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </button>
        <div class="topbar-logo">
            <i class="fas fa-robot"></i> LongGBot
        </div>
    </div>
    <div class="container">
        <div class="main-content">
            <div class="sidebar" id="sidebar">
                <div class="header">
                    <h1><i class="fas fa-robot"></i> LongGBot</h1>
                    <p>Advanced AI Assistant with Multiple Models</p>
                </div>
                <button id="botInfoBtn" class="btn" style="font-size:0.85em;padding:4px 10px;margin-top:8px;" onclick="showBotInfoModal()"><i class="fas fa-info-circle"></i> All Models Info</button>
                <button id="enterCodeBtn" class="btn" style="font-size:0.85em;padding:4px 10px;margin-top:8px;" onclick="showCodeModal()">Enter Premium Code</button>
                <span id="premiumIndicator" class="premium-indicator{% if premium %} active{% endif %}" style="display: none; align-items: center; margin-top:8px;">
                    <span style="color: #2ecc40; font-weight: bold;"><i class="fas fa-crown"></i> Premium</span>
                </span>
                <div class="section">
                    <div class="section-title">
                        <i class="fas fa-cog"></i> Settings
                    </div>
                    <div class="current-model">
                        Current Model: <span id="currentModel">
                            {% for model_id, model_name in chat_models %}
                                {% if model_id == current_model %}{{ model_name }}{% endif %}
                            {% endfor %}
                        </span>
                    </div>
                    <button class="btn primary" onclick="showModelSelector('chat')">
                        <i class="fas fa-brain"></i> Change Chat Model
                    </button>
                    <button class="btn primary" onclick="showModelSelector('image')">
                        <i class="fas fa-image"></i> Change Image Model
                    </button>
                    <button class="btn primary" onclick="clearContext()">
                        <i class="fas fa-trash"></i> Clear Chat History
                    </button>
                </div>

                <div class="section">
                    <div class="section-title">
                        <i class="fas fa-magic"></i> Quick Actions
                    </div>
                    <button class="btn" onclick="showImageUpload()" {% if not premium %}disabled title="Premium required. Enter a code to unlock."{% endif %}>
                        <i class="fas fa-upload"></i> Upload Image
                    </button>
                    <button class="btn" onclick="showImageGenerator()" {% if not premium %}disabled title="Premium required. Enter a code to unlock."{% endif %}>
                        <i class="fas fa-paint-brush"></i> Generate Image
                    </button>
                </div>
            </div>

            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="message assistant">
                        <div class="message-content">
                            Hello! I'm your AI assistant. I can help you with:
                            <br>• Chat and answer questions
                            <br>• Generate images from text descriptions
                            <br>• Analyze uploaded images
                            <br><br>What would you like to do today?
                        </div>
                    </div>
                </div>

                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <textarea 
                            id="messageInput" 
                            class="chat-input" 
                            placeholder="Type your message here..."
                            onkeydown="handleKeyPress(event)"
                            onpaste="handlePaste(event)"></textarea>
                        <button class="send-btn" onclick="sendMessage()" id="sendBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    </div> <!-- end of .container -->

    <!-- Modal for Chat Model Selector -->
    <div id="chatModelModal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <div class="section-title">Select Chat Model</div>
            {% for model_id, model_name in chat_models %}
            <div class="model-option" data-model-id="{{ model_id }}" onclick="modelOptionClick('{{ model_id }}', 'chat')">
                <input type="radio" name="chatModel" value="{{ model_id }}" id="chatRadio_{{ model_id }}"> {{ model_name }}
            </div>
            {% endfor %}
            <button class="btn" onclick="hideModelSelector('chat')">Cancel</button>
        </div>
    </div>

    <!-- Modal for Image Model Selector -->
    <div id="imageModelModal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <div class="section-title">Select Image Model</div>
            {% for model_id, model_name in image_models %}
            <div class="model-option" data-model-id="{{ model_id }}" onclick="modelOptionClick('{{ model_id }}', 'image')">
                <input type="radio" name="imageModel" value="{{ model_id }}" id="imageRadio_{{ model_id }}"> {{ model_name }}
            </div>
            {% endfor %}
            <button class="btn" onclick="hideModelSelector('image')">Cancel</button>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="alertModal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <div class="section-title" id="alertMessage">Alert</div>
            <button class="btn" onclick="hideAlert()">OK</button>
        </div>
    </div>

    <!-- Image Upload Modal -->
    <div id="imageUploadModal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <div class="section-title">Upload Image</div>
            <input type="file" id="imageFile" accept="image/*" class="image-upload">
            <button class="btn" onclick="document.getElementById('imageFile').click()">
                <i class="fas fa-folder-open"></i> Choose File
            </button>
            <button class="btn" onclick="uploadImage()">
                <i class="fas fa-upload"></i> Upload
            </button>
            <button class="btn" onclick="hideImageUpload()">Cancel</button>
        </div>
    </div>

    <!-- Image Generator Modal -->
    <div id="imageGeneratorModal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <div class="section-title">Generate Image</div>
            <textarea id="imagePrompt" placeholder="Describe the image you want to generate..." style="width: 100%; height: 80px; margin-bottom: 10px; padding: 8px; border-radius: 6px; border: 1px solid #ddd;"></textarea>
            <button class="btn" onclick="generateImage()">
                <i class="fas fa-magic"></i> Generate
            </button>
            <button class="btn" onclick="hideImageGenerator()">Cancel</button>
        </div>
    </div>

    <!-- Premium Code Modal -->
    <div id="codeModal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <div class="section-title">Enter Premium Code</div>
            <input type="text" id="codeInput" placeholder="Enter code here..." style="width:100%;margin-bottom:10px;font-size:0.95em;padding:8px;" />
            <button class="btn" onclick="submitCode()">Submit</button>
            <button class="btn" onclick="hideCodeModal()">Cancel</button>
            <div id="codeError" style="color:red;margin-top:8px;"></div>
        </div>
    </div>

    <!-- Bot Info Modal -->
    <div id="botInfoModal" class="modal-overlay" style="display:none;z-index:3000;">
        <div class="modal-content" style="max-width:420px;">
            <div class="section-title"><i class="fas fa-info-circle"></i> Bot Info</div>
            <ul style="font-size:0.97em;line-height:1.5;margin:0 0 10px 0;padding-left:18px;">
                <li><b>GPT 4o Mini Search</b>: Free, Web search, <span style="color:#b8860b">No image analysis</span></li>
                <li><b>Claude Opus 4</b>: Premium, No web search, <span style="color:#2ecc40">Image analysis</span></li>
                <li><b>GPT o3 High</b>: Premium, No web search, <span style="color:#2ecc40">Image analysis</span></li>
                <li><b>Gemini 2.5 Pro</b>: Premium, No web search, <span style="color:#2ecc40">Image analysis</span></li>
                <li><b>Perplexity Sonar Reasoning Pro</b>: Premium, Web search, <span style="color:#b8860b">No image analysis</span></li>
                <li><b>All Image Models</b>: Premium, <span style="color:#2ecc40">Image generation</span></li>
            </ul>
            <div style="font-size:0.93em;color:#888;">Use the <b>Enter Premium Code</b> button to unlock all features and models.</div>
            <button class="btn" style="margin-top:18px;" onclick="hideBotInfoModal()">Close</button>
        </div>
    </div>
    <!-- Model ID to Name mapping for JS -->
    <script id="model-names" type="application/json">{
{% for model_id, model_name in chat_models %}    "{{ model_id }}": "{{ model_name }}"{% if not loop.last %},{% endif %}
{% endfor %}
}</script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        let currentImageData = null;
        let currentImageModel = 'imagen-4.0-ultra-generate-exp-05-20';
        let currentChatModel = '{{ current_model }}';

        // Add subtle particle effect
        function createParticles() {
            const particlesContainer = document.createElement('div');
            particlesContainer.id = 'particles';
            particlesContainer.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
                z-index: -1;
                overflow: hidden;
            `;
            document.body.appendChild(particlesContainer);

            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.style.cssText = `
                    position: absolute;
                    width: 4px;
                    height: 4px;
                    background: rgba(74, 74, 138, 0.1);
                    border-radius: 50%;
                    animation: float ${5 + Math.random() * 10}s linear infinite;
                    left: ${Math.random() * 100}%;
                    top: ${Math.random() * 100}%;
                `;
                particlesContainer.appendChild(particle);
            }
        }

        // Add floating animation for particles
        const style = document.createElement('style');
        style.textContent = `
            @keyframes float {
                0% {
                    transform: translateY(100vh) rotate(0deg);
                    opacity: 0;
                }
                10% {
                    opacity: 1;
                }
                90% {
                    opacity: 1;
                }
                100% {
                    transform: translateY(-100px) rotate(360deg);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        // Initialize particles on page load
        window.addEventListener('load', createParticles);

        const PREMIUM_MODELS = [
            "claude-opus-4-20250514-thinking",
            "o3-high",
            "gemini-2.5-pro-preview-05-06",
            "sonar-reasoning-pro",
            "o3-mini-online",
            "imagen-4.0-ultra-generate-exp-05-20",
            "flux-1-kontext-max",
            "gpt-image-1",
            "midjourney-v7",
            "hidream-i1-full"
        ];
        const FREE_MODEL = "gpt-4o-mini-search-preview-2025-03-11";

        // Parse model ID to name mapping from JSON script tag
        const MODEL_ID_TO_NAME = JSON.parse(document.getElementById('model-names').textContent);

        // Move hideAllSelectors to the top to avoid reference errors
        function hideAllSelectors() {
            document.getElementById('chatModelModal').style.display = 'none';
            document.getElementById('imageModelModal').style.display = 'none';
            document.getElementById('imageUploadModal').style.display = 'none';
            document.getElementById('imageGeneratorModal').style.display = 'none';
        }

        // Helper function to hide sidebar on mobile when modals are opened
        function hideSidebarOnMobile() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (sidebar && window.innerWidth <= 700) {
                sidebar.classList.remove('open');
                if (overlay) overlay.style.display = 'none';
            }
        }

        // Initialize micro-interactions on page load
        window.addEventListener('load', addMicroInteractions);

        // On page load, load conversation history
        window.onload = function() {
            console.log('Page loaded, setting up event listeners...');
            
            // Clear any existing image indicator
            const indicator = document.getElementById('imageIndicator');
            if (indicator) {
                indicator.remove();
            }
            
            fetch('/history')
                .then(response => response.json())
                .then(data => {
                    if (data.history && Array.isArray(data.history)) {
                        data.history.forEach(msg => {
                            addMessage(msg.role === 'user' ? 'user' : 'assistant', msg.content);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading history:', error);
                });
        };

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function handlePaste(event) {
            const items = (event.clipboardData || event.originalEvent.clipboardData).items;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    const file = items[i].getAsFile();
                    if (file) {
                        // Validate file type - only accept image files
                        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp', 'image/bmp'];
                        if (!allowedTypes.includes(file.type)) {
                            showAlert('Only image files can be pasted. Please paste a JPEG, PNG, GIF, WebP, or BMP image.');
                            return;
                        }
                        
                        // Validate file size (max 10MB)
                        const maxSize = 10 * 1024 * 1024; // 10MB
                        if (file.size > maxSize) {
                            showAlert('Image file too large. Please paste an image smaller than 10MB.');
                            return;
                        }
                        
                        // Show preview (optional)
                        const reader = new FileReader();
                        let previewDiv = null;
                        reader.onload = function(e) {
                            previewDiv = addMessage('user', '<b>Image pasted and uploading...</b><br><img src="' + e.target.result + '" style="max-width:200px;max-height:200px;">');
                        };
                        reader.readAsDataURL(file);
                        // Upload image
                        const formData = new FormData();
                        formData.append('image', file);
                        fetchWithCode('/upload_image', {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (previewDiv && previewDiv.parentNode) previewDiv.parentNode.removeChild(previewDiv);
                            if (data.success) {
                                currentImageData = data.image;
                                addMessage('user', 'Image uploaded successfully!');
                                addMessage('assistant', 'Image uploaded! You can now ask me to analyze it or use it for editing.');
                            } else {
                                addMessage('assistant', `Error: ${data.error}`, 'error');
                            }
                        })
                        .catch(error => {
                            if (previewDiv && previewDiv.parentNode) previewDiv.parentNode.removeChild(previewDiv);
                            addMessage('assistant', `Error: ${error.message}`, 'error');
                        });
                        event.preventDefault();
                        break;
                    }
                }
            }
        }

        function sendMessage() {
            console.log('sendMessage called');
            const input = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const message = input.value.trim();
            if (!message) return;
            
            // Add loading state to send button
            sendBtn.classList.add('loading');
            sendBtn.disabled = true;
            
            // If there's an image, show it in the user message
            if (currentImageData) {
                addMessage('user', message, 'normal', currentImageData);
            } else {
                addMessage('user', message);
            }
            input.value = '';
            
            // Reset input styling and remove image indicator
            input.placeholder = "Type your message here...";
            input.style.borderColor = "";
            input.style.boxShadow = "";
            const indicator = document.getElementById('imageIndicator');
            if (indicator) {
                indicator.remove();
            }
            
            // Insert an animated 'thinking...' assistant message and keep its element
            let thinkingMessage = createThinkingIndicator();
            if (currentImageData) {
                thinkingMessage = createThinkingIndicator().replace('thinking', 'analyzing image');
            }
            const thinkingDiv = addMessage('assistant', thinkingMessage, 'thinking');
            
            // Prepare request data
            const requestData = { message: message };
            
            // If there's an uploaded image, include it in the request
            if (currentImageData) {
                requestData.image = currentImageData;
                // Clear the current image data after sending
                currentImageData = null;
            }
            
            fetchWithCode('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                // Remove loading state
                sendBtn.classList.remove('loading');
                sendBtn.disabled = false;
                
                // Remove the 'thinking...' message
                if (thinkingDiv && thinkingDiv.parentNode) thinkingDiv.parentNode.removeChild(thinkingDiv);
                if (data.error) {
                    addMessage('assistant', `Error: ${data.error}`, 'error');
                } else if (data.type === 'image_request') {
                    document.getElementById('imagePrompt').value = data.prompt;
                    showImageGenerator();
                } else {
                    addMessage('assistant', data.response);
                }
            })
            .catch(error => {
                // Remove loading state
                sendBtn.classList.remove('loading');
                sendBtn.disabled = false;
                
                if (thinkingDiv && thinkingDiv.parentNode) thinkingDiv.parentNode.removeChild(thinkingDiv);
                addMessage('assistant', `Error: ${error.message}`, 'error');
            });
        }

        function createThinkingIndicator() {
            return `**thinking**...`;
        }

        function createGeneratingIndicator() {
            return `**Generating image**...`;
        }

        function createTypingIndicator() {
            return `
                <div class="typing-indicator">
                    <span>AI is typing</span>
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
        }

        function markdownTableToHtml(md) {
            // Convert markdown table to HTML table
            // Only supports simple tables (no row/colspan, no alignment)
            const lines = md.trim().split('\n');
            if (lines.length < 2 || !lines[1].match(/^\|[-| ]+\|$/)) return md; // Not a table
            let html = '<table class="md-table"><thead><tr>';
            const headers = lines[0].split('|').slice(1, -1).map(h => h.trim());
            headers.forEach(h => html += `<th>${h}</th>`);
            html += '</tr></thead><tbody>';
            for (let i = 2; i < lines.length; i++) {
                if (!lines[i].trim().startsWith('|')) continue;
                html += '<tr>';
                const cells = lines[i].split('|').slice(1, -1).map(c => c.trim());
                cells.forEach(c => html += `<td>${c}</td>`);
                html += '</tr>';
            }
            html += '</tbody></table>';
            return html;
        }

        function extractSources(md) {
            // Find a 'Sources:' section and build a mapping
            const sources = {};
            const match = md.match(/Sources?:\s*([\s\S]*)/i);
            if (match) {
                const lines = match[1].split(/\n|<br>/);
                lines.forEach(line => {
                    const m = line.match(/(\d+)\.\s*(https?:\/\/\S+)/);
                    if (m) sources[m[1]] = m[2];
                });
            }
            return sources;
        }

        function linkifyReferences(md, sources) {
            // Replace [1], [2], ... with links if mapping exists
            return md.replace(/\[(\d+)\]/g, (m, n) => {
                if (sources[n]) return `<a href="${sources[n]}" target="_blank">[${n}]</a>`;
                return m;
            });
        }

        // Enhanced scroll to bottom with smooth animation
        function smoothScrollToBottom(container) {
            // Add a small delay to ensure DOM updates are complete
            setTimeout(() => {
            const scrollHeight = container.scrollHeight;
            const clientHeight = container.clientHeight;
            const maxScrollTop = scrollHeight - clientHeight;
                
                // On mobile, add extra padding to ensure last message is visible
                const isMobile = window.innerWidth <= 700;
                const extraPadding = isMobile ? 20 : 0;
            
            container.scrollTo({
                    top: maxScrollTop + extraPadding,
                behavior: 'smooth'
            });
            }, 50);
        }

        // Add micro-interactions
        function addMicroInteractions() {
            // Add ripple effect to buttons
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('btn') || e.target.closest('.btn')) {
                    const button = e.target.classList.contains('btn') ? e.target : e.target.closest('.btn');
                    const ripple = document.createElement('span');
                    const rect = button.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    const x = e.clientX - rect.left - size / 2;
                    const y = e.clientY - rect.top - size / 2;
                    
                    ripple.style.cssText = `
                        position: absolute;
                        width: ${size}px;
                        height: ${size}px;
                        left: ${x}px;
                        top: ${y}px;
                        background: rgba(255, 255, 255, 0.3);
                        border-radius: 50%;
                        transform: scale(0);
                        animation: ripple 0.6s linear;
                        pointer-events: none;
                    `;
                    
                    button.appendChild(ripple);
                    setTimeout(() => ripple.remove(), 600);
                }
            });

            // Add ripple animation
            const rippleStyle = document.createElement('style');
            rippleStyle.textContent = `
                @keyframes ripple {
                    to {
                        transform: scale(4);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(rippleStyle);
        }

        // Enhanced addMessage function with proper markdown rendering
        function addMessage(sender, content, type = 'normal', imageData = null) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            let messageContent = '';
            
            if (sender === 'assistant' && type !== 'error' && type !== 'success') {
                // Use proper markdown rendering for assistant messages
                let htmlContent = content;
                
                // Remove <think> blocks if present
                htmlContent = htmlContent.replace(/<think>[\s\S]*?<\/think>/gi, '');
                
                // Use marked library to render markdown
                htmlContent = marked.parse(htmlContent);
                
                // Extract sources and linkify references (keep this for compatibility)
                const sources = extractSources(htmlContent);
                htmlContent = linkifyReferences(htmlContent, sources);
                
                if (imageData) {
                    // Show image above the text
                    messageContent = `<div class="message-content">` +
                        `<img src="${imageData}" class="message-image" alt="Generated image" style="display:block;margin-bottom:10px;max-width:100%;border-radius:8px;" onload="this.parentElement.parentElement.parentElement.scrollTop = this.parentElement.parentElement.parentElement.scrollHeight;">` +
                        `${htmlContent}</div>`;
                } else {
                    messageContent = `<div class="message-content">${htmlContent}</div>`;
                }
            } else if (sender === 'user') {
                // Display user messages as plain text only
                let plainText = content;
                
                // Remove <think> blocks if present
                plainText = plainText.replace(/<think>[\s\S]*?<\/think>/gi, '');
                
                // Escape HTML to display as plain text
                plainText = plainText
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
                
                // Convert line breaks to <br> for display
                plainText = plainText.replace(/\n/g, '<br>');
                
                messageContent = `<div class="message-content">${plainText}</div>`;
            } else {
                // For system messages (error, success, thinking, generating), keep basic formatting
                let htmlContent = content;
                
                // Remove <think> blocks if present
                htmlContent = htmlContent.replace(/<think>[\s\S]*?<\/think>/gi, '');
                
                // Basic formatting for system messages (just line breaks and basic bold)
                htmlContent = htmlContent.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
                
                if (type === 'error') {
                    messageContent = `<div class="message-content error">${htmlContent}</div>`;
                } else if (type === 'success') {
                    messageContent = `<div class="message-content success">${htmlContent}</div>`;
                } else if (type === 'thinking') {
                    messageContent = `<div class="message-content">${htmlContent}</div>`;
                } else if (type === 'generating') {
                    messageContent = `<div class="message-content">${htmlContent}</div>`;
                } else {
                    messageContent = `<div class="message-content">${htmlContent}</div>`;
                }
            }
            
            messageDiv.innerHTML = messageContent;
            messagesContainer.appendChild(messageDiv);
            
            // Add entrance animation
            messageDiv.style.opacity = '0';
            messageDiv.style.transform = sender === 'user' ? 'translateX(30px)' : 'translateX(-30px)';
            
            // Trigger animation after a small delay
            setTimeout(() => {
                messageDiv.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                messageDiv.style.opacity = '1';
                messageDiv.style.transform = 'translateX(0)';
            }, 10);
            
            // Smooth scroll to bottom
            setTimeout(() => {
                smoothScrollToBottom(messagesContainer);
            }, 100);
            
            // If there's an image, scroll again after it loads
            if (imageData) {
                const img = messageDiv.querySelector('img');
                if (img) {
                    img.onload = () => {
                        setTimeout(() => {
                            smoothScrollToBottom(messagesContainer);
                        }, 100);
                    };
                }
            }
            
            return messageDiv;
        }

        function showModelSelector(type) {
            hideAllSelectors();
            hideSidebarOnMobile(); // Hide sidebar on mobile when modal opens
            if (type === 'chat') {
                const modal = document.getElementById('chatModelModal');
                modal.style.display = 'flex';
                modal.style.opacity = '0';
                setTimeout(() => {
                    modal.style.transition = 'opacity 0.2s ease-out';
                    modal.style.opacity = '1';
                }, 10);
                // Highlight and check the current chat model only
                setTimeout(() => {
                    for (const el of document.getElementsByName('chatModel')) {
                        if (el.value === currentChatModel) {
                            el.checked = true;
                            el.parentElement.classList.add('selected');
                        } else {
                            el.checked = false;
                            el.parentElement.classList.remove('selected');
                        }
                    }
                }, 0);
            } else if (type === 'image') {
                const modal = document.getElementById('imageModelModal');
                modal.style.display = 'flex';
                modal.style.opacity = '0';
                setTimeout(() => {
                    modal.style.transition = 'opacity 0.2s ease-out';
                    modal.style.opacity = '1';
                }, 10);
                // Highlight and check the current image model only
                setTimeout(() => {
                    for (const el of document.getElementsByName('imageModel')) {
                        if (el.value === currentImageModel) {
                            el.checked = true;
                            el.parentElement.classList.add('selected');
                        } else {
                            el.checked = false;
                            el.parentElement.classList.remove('selected');
                        }
                    }
                }, 0);
            }
        }

        function hideModelSelector(type) {
            console.log('hideModelSelector called with type:', type);
            if (type === 'chat') {
                const modal = document.getElementById('chatModelModal');
                modal.style.transition = 'opacity 0.2s ease-out';
                modal.style.opacity = '0';
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 200);
            } else {
                const modal = document.getElementById('imageModelModal');
                modal.style.transition = 'opacity 0.2s ease-out';
                modal.style.opacity = '0';
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 200);
            }
        }

        function selectModel(modelId, type) {
            if (type === 'chat') {
                currentChatModel = modelId;
                document.getElementById('currentModel').textContent = MODEL_ID_TO_NAME[modelId] || modelId;
                // Update chat model UI only
                for (const el of document.getElementsByName('chatModel')) {
                    if (el.value === modelId) {
                        el.checked = true;
                        el.parentElement.classList.add('selected');
                    } else {
                        el.checked = false;
                        el.parentElement.classList.remove('selected');
                    }
                }
            } else if (type === 'image') {
                currentImageModel = modelId;
                // Update image model UI only
                for (const el of document.getElementsByName('imageModel')) {
                    if (el.value === modelId) {
                        el.checked = true;
                        el.parentElement.classList.add('selected');
                    } else {
                        el.checked = false;
                        el.parentElement.classList.remove('selected');
                    }
                }
            }
            fetchWithCode('/set_model', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ model: modelId, model_type: type })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    hideModelSelector(type);
                    addMessage('assistant', 'Model changed successfully!', 'success');
                } else {
                    addMessage('assistant', `Error: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                addMessage('assistant', `Error: ${error.message}`, 'error');
            });
        }

        function clearContext() {
            console.log('clearContext called');
            if (confirm('Are you sure you want to clear the chat history?')) {
                fetch('/clear_context', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Clear current image data
                        currentImageData = null;
                        
                        // Reset input styling and remove image indicator
                        const input = document.getElementById('messageInput');
                        input.placeholder = "Type your message here...";
                        input.style.borderColor = "";
                        input.style.boxShadow = "";
                        const indicator = document.getElementById('imageIndicator');
                        if (indicator) {
                            indicator.remove();
                        }
                        
                        document.getElementById('chatMessages').innerHTML = `
                            <div class="message assistant">
                                <div class="message-content">
                                    Chat history cleared! How can I help you today?
                                </div>
                            </div>
                        `;
                    } else {
                        addMessage('assistant', `Error: ${data.error}`, 'error');
                    }
                })
                .catch(error => {
                    addMessage('assistant', `Error: ${error.message}`, 'error');
                });
            }
        }

        function showImageUpload() {
            hideAllSelectors();
            hideSidebarOnMobile(); // Hide sidebar on mobile when modal opens
            const modal = document.getElementById('imageUploadModal');
            modal.style.display = 'flex';
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.transition = 'opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                modal.style.opacity = '1';
            }, 10);
        }

        function hideImageUpload() {
            console.log('hideImageUpload called');
            const modal = document.getElementById('imageUploadModal');
            modal.style.transition = 'opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        function uploadImage() {
            console.log('uploadImage called');
            const fileInput = document.getElementById('imageFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showAlert('Please select a file first');
                return;
            }
            
            // Validate file type - only accept image files
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp', 'image/bmp'];
            if (!allowedTypes.includes(file.type)) {
                showAlert('Only image files are allowed. Please select a JPEG, PNG, GIF, WebP, or BMP file.');
                fileInput.value = '';
                return;
            }
            
            // Validate file size (max 10MB)
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                showAlert('File size too large. Please select an image smaller than 10MB.');
                fileInput.value = '';
                return;
            }
            
            // Add loading state to upload button
            const uploadBtn = document.querySelector('#imageUploadModal .btn:nth-child(3)');
            uploadBtn.classList.add('loading');
            uploadBtn.disabled = true;
            
            const formData = new FormData();
            formData.append('image', file);
            
            fetch('/upload_image', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // Remove loading state
                uploadBtn.classList.remove('loading');
                uploadBtn.disabled = false;
                
                if (data.success) {
                    currentImageData = data.image;
                    // Only show the floating indicator and the assistant message
                    addMessage('assistant', 'Image uploaded! You can now ask me to analyze it or use it for editing.');
                    hideImageUpload();
                    
                    // Update chat input placeholder to indicate image is ready
                    const messageInput = document.getElementById('messageInput');
                    messageInput.placeholder = "Ask me about the uploaded image...";
                    messageInput.style.borderColor = "#4a4a8a";
                    messageInput.style.boxShadow = "0 0 10px rgba(74, 74, 138, 0.3)";
                    
                    // Add a small indicator
                    const indicator = document.createElement('div');
                    indicator.id = 'imageIndicator';
                    indicator.innerHTML = `<i class="fas fa-image"></i> Image ready (click to remove)`;
                    if (data.image) {
                        const thumb = document.createElement('img');
                        thumb.src = data.image;
                        thumb.alt = 'preview';
                        thumb.style.cssText = `
                            width: 36px;
                            height: 36px;
                            object-fit: cover;
                            border-radius: 8px;
                            margin-right: 10px;
                            vertical-align: middle;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
                            border: 1px solid #eee;
                            background: #fff;
                            display: inline-block;
                        `;
                        indicator.prepend(thumb);
                    }
                    
                    // Add hover effect
                    indicator.style.cssText = `
                        position: fixed;
                        bottom: 90px;
                        right: 40px;
                        z-index: 2000;
                        background: #4a4a8a;
                        color: white;
                        padding: 8px 16px 8px 8px;
                        border-radius: 16px;
                        font-size: 1rem;
                        box-shadow: 0 8px 32px rgba(0,0,0,0.18);
                        animation: fadeInUp 0.3s ease-out;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        transition: all 0.2s;
                    `;
                    indicator.addEventListener('mouseenter', function() {
                        this.style.background = '#6a6a9a';
                        this.style.transform = 'scale(1.05)';
                    });
                    indicator.addEventListener('mouseleave', function() {
                        this.style.background = '#4a4a8a';
                        this.style.transform = 'scale(1)';
                    });
                    
                    messageInput.parentElement.style.position = 'relative';
                    messageInput.parentElement.appendChild(indicator);
                } else {
                    addMessage('assistant', `Error: ${data.error}`, 'error');
                }
                document.getElementById('imageFile').value = '';
            })
            .catch(error => {
                // Remove loading state
                uploadBtn.classList.remove('loading');
                uploadBtn.disabled = false;
                
                addMessage('assistant', `Error: ${error.message}`, 'error');
                document.getElementById('imageFile').value = '';
            });
        }

        function showImageGenerator() {
            hideAllSelectors();
            hideSidebarOnMobile(); // Hide sidebar on mobile when modal opens
            const modal = document.getElementById('imageGeneratorModal');
            modal.style.display = 'flex';
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.transition = 'opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                modal.style.opacity = '1';
            }, 10);
        }

        function hideImageGenerator() {
            console.log('hideImageGenerator called');
            const modal = document.getElementById('imageGeneratorModal');
            modal.style.transition = 'opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        function generateImage() {
            const prompt = document.getElementById('imagePrompt').value.trim();
            if (!prompt) {
                showAlert('Please enter a prompt');
                return;
            }
            
            // Add loading state to generate button - use a more reliable selector
            const generateBtn = document.querySelector('#imageGeneratorModal button[onclick="generateImage()"]');
            if (generateBtn) {
                generateBtn.classList.add('loading');
                generateBtn.disabled = true;
            }
            
            hideImageGenerator(); // Close the modal immediately
            // Show 'Generating image...' message
            addMessage('user', `Generate image: ${prompt}`);
            const thinkingDiv = addMessage('assistant', createGeneratingIndicator(), 'generating');
            fetchWithCode('/generate_image', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    prompt: prompt,
                    model: currentImageModel
                })
            })
            .then(response => response.json())
            .then(data => {
                // Remove loading state
                if (generateBtn) {
                    generateBtn.classList.remove('loading');
                    generateBtn.disabled = false;
                }
                
                // Remove the 'Generating image...' message
                if (thinkingDiv && thinkingDiv.parentNode) thinkingDiv.parentNode.removeChild(thinkingDiv);
                if (data.error) {
                    addMessage('assistant', `Error: ${data.error}`, 'error');
                } else {
                    let imageMsg = 'Generated image:';
                    if (data.image_url) {
                        imageMsg += `<br><a href="${data.image_url}" target="_blank">View Image URL</a>`;
                    }
                    addMessage('assistant', imageMsg, 'normal', data.image);
                }
                document.getElementById('imagePrompt').value = '';
            })
            .catch(error => {
                // Remove loading state
                if (generateBtn) {
                    generateBtn.classList.remove('loading');
                    generateBtn.disabled = false;
                }
                
                if (thinkingDiv && thinkingDiv.parentNode) thinkingDiv.parentNode.removeChild(thinkingDiv);
                addMessage('assistant', `Error: ${error.message}`, 'error');
            });
        }

        function testClick() {
            console.log('testClick called');
            alert('Test click works! If you see this, clicking is working.');
            addMessage('assistant', 'Test click successful! Clicking is working properly.');
        }

        function showAlert(message) {
            hideSidebarOnMobile(); // Hide sidebar on mobile when modal opens
            const modal = document.getElementById('alertModal');
            modal.style.display = 'flex';
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.transition = 'opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                modal.style.opacity = '1';
            }, 10);
            document.getElementById('alertMessage').textContent = message;
        }

        function hideAlert() {
            const modal = document.getElementById('alertModal');
            modal.style.transition = 'opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('open');
            if (window.innerWidth <= 700) {
                if (sidebar.classList.contains('open')) {
                    overlay.style.display = 'block';
                } else {
                    overlay.style.display = 'none';
                }
            } else {
                overlay.style.display = 'none';
            }
        }

        function getPremiumCode() {
            return localStorage.getItem('premium_code') || '';
        }
        function hasPremiumAccess() {
            return localStorage.getItem('premium_code_valid') === 'true';
        }
        function showCodeModal(errorMsg = '') {
            hideSidebarOnMobile(); // Hide sidebar on mobile when modal opens
            const modal = document.getElementById('codeModal');
            modal.style.display = 'flex';
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.transition = 'opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                modal.style.opacity = '1';
            }, 10);
            document.getElementById('codeError').textContent = errorMsg || '';
            document.getElementById('codeInput').value = getPremiumCode();
        }
        function hideCodeModal() {
            const modal = document.getElementById('codeModal');
            modal.style.transition = 'opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }
        function submitCode() {
            const code = document.getElementById('codeInput').value.trim();
            // Validate code with backend
            fetch('/validate_code', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code })
            })
            .then(res => res.json().then(data => ({ status: res.status, data })))
            .then(({ status, data }) => {
                if (status === 200 && data.valid) {
                    localStorage.setItem('premium_code', code);
                    localStorage.setItem('premium_code_valid', 'true');
                    hideCodeModal();
                    window.location.reload();
                } else {
                    localStorage.setItem('premium_code', '');
                    localStorage.setItem('premium_code_valid', 'false');
                    document.getElementById('codeError').textContent = 'Invalid code!';
                    updateModelSelectors();
                }
            });
            updatePremiumIndicator();
        }
        function updateModelSelectors() {
            // Chat models
            document.querySelectorAll('.model-option').forEach(opt => {
                const val = opt.getAttribute('data-model-id');
                // Add Free label to the free model
                if (val === FREE_MODEL) {
                    if (!opt.querySelector('.free-label')) {
                        const label = document.createElement('span');
                        label.className = 'free-label';
                        label.textContent = 'Free';
                        opt.appendChild(label);
                    }
                } else {
                    const label = opt.querySelector('.free-label');
                    if (label) label.remove();
                }
                if (PREMIUM_MODELS.includes(val) && val !== FREE_MODEL) {
                    if (!hasPremiumAccess()) {
                        opt.classList.add('premium-disabled');
                        if (!opt.querySelector('.premium-label')) {
                            const label = document.createElement('span');
                            label.className = 'premium-label';
                            label.textContent = 'Premium';
                            opt.appendChild(label);
                        }
                    } else {
                        opt.classList.remove('premium-disabled');
                        const label = opt.querySelector('.premium-label');
                        if (label) label.remove();
                    }
                } else {
                    opt.classList.remove('premium-disabled');
                    const label = opt.querySelector('.premium-label');
                    if (label) label.remove();
                }
            });
        }
        window.addEventListener('DOMContentLoaded', updateModelSelectors);

        // Patch model selector click logic
        function modelOptionClick(modelId, type) {
            if (PREMIUM_MODELS.includes(modelId) && modelId !== FREE_MODEL && !hasPremiumAccess()) {
                showCodeModal('Enter a valid premium code to use this model.');
                return;
            }
            selectModel(modelId, type);
        }

        function updatePremiumIndicator() {
            const indicator = document.getElementById('premiumIndicator');
            const enterCodeBtn = document.getElementById('enterCodeBtn');
            const indicatorMobile = document.getElementById('premiumIndicatorMobile');
            const enterCodeBtnMobile = document.getElementById('enterCodeBtnMobile');
            
            console.log('updatePremiumIndicator called');
            console.log('hasPremiumAccess():', hasPremiumAccess());
            console.log('indicator:', indicator);
            console.log('indicatorMobile:', indicatorMobile);
            
            if (hasPremiumAccess()) {
                console.log('Setting premium indicators to active');
                if (indicator) {
                    indicator.classList.add('active');
                    indicator.style.display = 'inline-flex';
                }
                if (indicatorMobile) {
                    indicatorMobile.classList.add('active');
                    indicatorMobile.style.display = 'inline-flex';
                }
                if (enterCodeBtn) enterCodeBtn.style.display = 'none';
                if (enterCodeBtnMobile) enterCodeBtnMobile.style.display = 'none';
            } else {
                console.log('Setting premium indicators to inactive - hiding them');
                if (indicator) {
                    indicator.classList.remove('active');
                    indicator.style.display = 'none';
                }
                if (indicatorMobile) {
                    indicatorMobile.classList.remove('active');
                    indicatorMobile.style.display = 'none';
                }
                if (enterCodeBtn) enterCodeBtn.style.display = 'inline-block';
                if (enterCodeBtnMobile) enterCodeBtnMobile.style.display = 'inline-block';
            }
        }
        
        // Call updatePremiumIndicator on page load and after DOM is ready
        window.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded - updating premium indicator');
            updatePremiumIndicator();
            
            // Additional mobile-specific initialization
            if (window.innerWidth <= 700) {
                console.log('Mobile device detected - ensuring mobile premium indicator is properly initialized');
                const indicatorMobile = document.getElementById('premiumIndicatorMobile');
                const enterCodeBtnMobile = document.getElementById('enterCodeBtnMobile');
                
                if (indicatorMobile) {
                    console.log('Mobile premium indicator found:', indicatorMobile);
                }
                if (enterCodeBtnMobile) {
                    console.log('Mobile enter code button found:', enterCodeBtnMobile);
                }
            }
            
            var input = document.getElementById('messageInput');
            var chatMessages = document.getElementById('chatMessages');
            if (input && chatMessages) {
                input.addEventListener('focus', function() {
                    setTimeout(function() {
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }, 300);
                });
            }
            window.addEventListener('resize', function() {
                setTimeout(function() {
                    if (chatMessages) chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 300);
            });
            
            // Handle viewport changes for mobile browser UI
            let lastViewportHeight = window.innerHeight;
            function handleViewportChange() {
                const currentHeight = window.innerHeight;
                if (Math.abs(currentHeight - lastViewportHeight) > 50) {
                    // Significant height change (likely keyboard open/close)
                    setTimeout(function() {
                        if (chatMessages) {
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }
                        // Force a reflow to ensure proper positioning
                        document.body.style.height = '100dvh';
                        setTimeout(function() {
                            document.body.style.height = '';
                        }, 10);
                    }, 100);
                }
                lastViewportHeight = currentHeight;
            }
            
            window.addEventListener('resize', handleViewportChange);
            window.addEventListener('orientationchange', function() {
                setTimeout(handleViewportChange, 500);
            });
        });
        
        window.addEventListener('load', function() {
            console.log('Window loaded - updating premium indicator');
            updatePremiumIndicator();
        });

        // Add resize listener to handle mobile premium indicator on screen size changes
        window.addEventListener('resize', function() {
            if (window.innerWidth <= 700) {
                console.log('Screen resized to mobile - updating premium indicator');
                updatePremiumIndicator();
            }
        });

        function fetchWithCode(url, options = {}) {
            const code = getPremiumCode();
            if (!options.headers) options.headers = {};
            options.headers['X-Access-Code'] = code;
            return fetch(url, options);
        }
        function showBotInfoModal() {
            hideSidebarOnMobile(); // Hide sidebar on mobile when modal opens
            const modal = document.getElementById('botInfoModal');
            modal.style.display = 'flex';
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.transition = 'opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                modal.style.opacity = '1';
            }, 10);
        }
        function hideBotInfoModal() {
            const modal = document.getElementById('botInfoModal');
            modal.style.transition = 'opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        function clearUploadedImage() {
            currentImageData = null;
            
            // Reset input styling and remove image indicator
            const input = document.getElementById('messageInput');
            input.placeholder = "Type your message here...";
            input.style.borderColor = "";
            input.style.boxShadow = "";
            const indicator = document.getElementById('imageIndicator');
            if (indicator) {
                indicator.remove();
            }
            
            addMessage('assistant', 'Uploaded image cleared. You can upload a new image or continue chatting.');
        }

        // Add click handler to image indicator to clear it
        function addImageIndicatorClickHandler() {
            document.addEventListener('click', function(e) {
                if (e.target.closest('#imageIndicator')) {
                    clearUploadedImage();
                }
            });
        }

        // Initialize image indicator click handler
        window.addEventListener('load', addImageIndicatorClickHandler);

        // Add click handler to close sidebar when clicking outside on mobile
        function addSidebarOverlayHandler() {
            document.addEventListener('click', function(e) {
                const sidebar = document.getElementById('sidebar');
                const topbarMobile = document.getElementById('topbarMobile');
                
                // If sidebar is open on mobile and click is outside sidebar and not on burger button
                if (sidebar && sidebar.classList.contains('open') && 
                    window.innerWidth <= 700 && 
                    !sidebar.contains(e.target) && 
                    !e.target.closest('.burger-btn')) {
                    sidebar.classList.remove('open');
                }
            });
        }

        // Initialize sidebar overlay handler
        window.addEventListener('load', addSidebarOverlayHandler);

        window.addEventListener('DOMContentLoaded', function() {
            var input = document.getElementById('messageInput');
            var chatMessages = document.getElementById('chatMessages');
            if (input && chatMessages) {
                input.addEventListener('focus', function() {
                    setTimeout(function() {
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }, 300);
                });
            }
            window.addEventListener('resize', function() {
                setTimeout(function() {
                    if (chatMessages) chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 300);
            });
        });
    </script>
    <div id="sidebarOverlay" class="sidebar-overlay" style="display: none;" onclick="toggleSidebar()"></div>
</body>
</html> 